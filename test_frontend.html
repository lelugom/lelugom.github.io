<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Prueba Ingeniero Front End</title>
    <link rel="shortcut icon" href="https://images.unsplash.com/photo-1473970367503-7d7f8d1bf998?ixlib=rb-0.3.5&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=200&fit=max&s=80e38058ebf664487e8f1d436580abf6">

    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <style type="text/css">
      body {
        background-image: url("https://images.unsplash.com/photo-1468476775582-6bede20f356f");
        background-repeat: no-repeat;
        background-size: cover;
        font-family: "Comic Sans MS", cursive, sans-serif;
      }
      #title {
        color: white;
        border-radius: 5px;
        margin-top: 10px;
        text-align: center;
        opacity: 0.8;
      }
      .uform {
        background-color: white;
        border-radius: 5px;
        margin-top: 10px;
        margin-bottom: 10px;
        padding-top: 20px;
        padding-bottom: 10px;
        border: 1px solid;
        text-align: center;
      }
      .hidden {
        display: none;
      }
      #validMsg #loginError {
        padding: 10px;
      }
      .pages {
        background-color: white;
        border-radius: 5px;
        margin-top: 10px;
        margin-bottom: 10px;
        padding: 10px;
        border: 1px solid;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1 id="title">Prueba para <br/>Ingeniero Front End</h1>

      <!-- Login form -->
      <div class="row">
        <div class="col-md-4 col-md-offset-4 uform" id="loginForm">
          <form>
            <div id="loginError"></div>
            <div class="form-group">
              <label class="control-label">Usuario</label>
              <input class="form-control" type="text" id="user" name="user"></input>
            </div>
            <div class="form-group">
              <label class="control-label">Contraseña</label>
              <input class="form-control" type="password" id="passwd" name="passwd"></input>
            </div>
            <div class="form-group">
              <input type="submit" class="btn btn-success" name="login" id="login" value="Ingresar"/>
            </div>
          </form>
        </div>
      </div>

      <!-- Page content -->
      <div class="row hidden" id="validContent">
        <!-- Validation form -->
        <div class="col-md-4 uform">
          <h4 class="text-success">Validación de usuarios</h4><hr/>
          <form>
            <div id="validMsg"></div>
            <div class="form-group">
              <label class="control-label">Nombre</label>
              <input class="form-control" type="text" id="validName" name="validName"></input>
            </div>
            <div class="form-group">
              <label class="control-label">Edad</label>
              <input class="form-control" type="text" id="validAge" name="validAge"></input>
            </div>
            <div class="form-group">
              <label class="control-label" id="validInLabel">Cédula </label>
              <input class="form-control" type="text" id="validIn" name="validIn"></input>
            </div>
            <div class="form-group">
              <input type="submit" class="btn btn-success" name="validate" id="validate" value="Validar datos"/>
            </div>
          </form>
        </div>

        <!-- Service pages -->
        <div class="col-md-8 pages">
          <nav aria-label="Page navigation">
            <ul class="pagination">
              <li class="page-item"><a class="page-link" href="" id="scheduleB">Agendas</a></li>
              <li class="page-item"><a class="page-link" href="" id="priceB">Precios</a></li>
              <li class="page-item"><a class="page-link" href="" id="policyB">Políticas</a></li>
            </ul>
          </nav>
          <table class="table" id="scheduleT">
            <thead class="thead-inverse"><tr>
              <th>Nombre</th><th>Descripción</th><th>Actualización</th><th>Estación</th>
            </tr></thead>
            <tbody id="scheduleTB"></tbody>
          </table>
          <table class="table hidden" id="priceT">
            <thead class="thead-default"><tr>
              <th>Pais</th><th>Imagen</th><th>Moneda</th>
            </tr></thead>
            <tbody id="priceTB"></tbody>
          </table>
          <table class="table hidden" id="policyT">
            <thead class="thead-default"><tr>
              <th>Nombre</th><th>Descripción</th><th>Actualización</th><th>Estación</th>
            </tr></thead>
            <tbody id="policyTB"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script type="text/javascript">
      var BASE_URL = 'http://fathomless-brushlands-1572.herokuapp.com/';

      // Events
      $(document).on("keypress", "form", function(event) {
        if(event.target.id != 'validIn'){
          return event.keyCode != 13;
        }
      });
      $("#login").click(function(event){
        loginUser(event);
      });
      $("#validate").click(function(event){
        validateUser(event);
      });
      $("#scheduleB").click(function(event){
        popSchedule(event);
      });
      $("#priceB").click(function(event){
        popPrice(event);
      });
      $("#policyB").click(function(event){
        popPolicy(event);
      });

      // Log in user
      function loginUser(event){
        event.preventDefault();

        var user = $("#user").val();
        var passwd = $("#passwd").val();

        if(user == '' || passwd == ''){
          $("#loginError").html('<div class="alert alert-danger">Por favor ingrese usuario y contraseña<br/></div>');
        } else {
          // Request login service
          $.ajax({
            url : BASE_URL + '/user/login/domain/' + user + '/' + passwd,
            dataType : 'JSON',
            success : function(data){
              if(data.message == 'ErrorUserPass'){
                $("#loginError").html('<div class="alert alert-danger">Usuario o contraseña inválidos<br/></div>');
              } else {
                $("#loginForm").toggle();
                $("#validContent").removeClass("hidden");
                $("#loginError").html('');
                popSchedule(event);
              }
            }
          });
        }
      }

      // Validate user form
      function validateUser(event){
        event.preventDefault();

        var name = $("#validName").val();
        var age = $("#validAge").val();
        var vin = $("#validIn").val();
        var error = '';
        $("#validInLabel").html('Cédula');

        if(name == '' || age == '' || vin == ''){
          error += 'Por favor ingrese todos los datos del formulario<br/>';
        }
        if(name.match("^[A-Za-z ]{1,50}$") == null){
          error += 'Digite su nombre, máximo 50 letras o espacios<br/>';
        }
        if(age.match("^[0-9]{1,2}$") == null){
          error += 'Ingrese su edad correctamente, número de 0 a 99<br/>';
        }
        if(vin.match("^[0-9]+$") == null){
          error += 'Ingrese un número de cédula válido<br/>';
        }
        if(error == ''){
          // Request validation service
          $.ajax({
            url : BASE_URL + '/user/validate/' + name + '/' + age + '/' + vin,
            dataType : 'JSON',
            success : function(data){
              if(data.message == 'Ok'){
                $("#validInLabel").html('Cédula <span class="glyphicon glyphicon-ok large"></span>');
                $("#validMsg").html('<div class="alert alert-success">Usuario ' + name + ' validado!</div>');
              } else {
                $("#validMsg").html('<div class="alert alert-danger">No es posible validar el usuario ' + name + '</div>');
              }
            }
          });
        }
        if(error != '') {
          $("#validMsg").html('<div class="alert alert-danger">' + error + '</div>');
        }
      }

      // Populate schedule table
      function popSchedule(event){
        var i, len, sched, row;
        $("#scheduleTB").html('');
        event.preventDefault();
        toggleTables("#scheduleT");

        // Request schedule information
        $.ajax({
          url : BASE_URL + '/schedule/list/0/10/test/test',
          dataType : 'JSON',
          success : function(data){
            for(i = 0, len=data.data.length; i < len; i++){
              sched = data.data[i];
              row = "<tr>";
              row += "<td>" + sched.Name + "</td>";
              row += "<td>" + sched.Description + "</td>";
              row += "<td>" + sched.LastUpdate + "</td>";
              row += "<td>" + sched.CountStation + "</td>";
              row += "</tr>";
              $("#scheduleTB").append(row);
            }
          }
        });
      }

      // Populate price table
      function popPrice(event){
        var i, len, sched, row;
        $("#priceTB").html('');
        event.preventDefault();
        toggleTables("#priceT");

        // Request price information
        $.ajax({
          url : BASE_URL + '/price/countryList',
          dataType : 'JSON',
          success : function(data){
            for(i = 0, len=data.data.length; i < len; i++){
              sched = data.data[i];
              row = "<tr>";
              row += "<td>" + sched.Name + "</td>";
              row += "<td>" + sched.Image + "</td>";
              row += "<td>" + sched.Currency.Symbol + " " + sched.Currency.Name + "</td>";
              row += "</tr>";
              $("#priceTB").append(row);
            }
          }
        });
      }

      // Populate policy table
      function popPolicy(event){
        var i, len, sched, row;
        $("#policyTB").html('');
        event.preventDefault();
        toggleTables("#policyT");

        // Request policy information
        $.ajax({
          url : BASE_URL + '/policy/list/0/10/test/test',
          dataType : 'JSON',
          success : function(data){
            for(i = 0, len=data.data.length; i < len; i++){
              sched = data.data[i];
              row = "<tr>";
              row += "<td>" + sched.Name + "</td>";
              row += "<td>" + sched.Description + "</td>";
              row += "<td>" + sched.LastUpdate + "</td>";
              row += "<td>" + sched.CountStation + "</td>";
              row += "</tr>";
              $("#policyTB").append(row);
            }
          }
        });
      }

      // Display the proper table
      function toggleTables(table){
        $("#scheduleT").addClass("hidden");
        $("#policyT").addClass("hidden");
        $("#priceT").addClass("hidden");

        $(table).removeClass("hidden");
      }
    </script>
  </body>
</html>
