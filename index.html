<!DOCTYPE html>
<html lang = "en">
  <head>
    <meta charset = "utf-8">
    <meta http-equiv = "X-UA-Compatible" content = "IE=edge">
    <meta name = "viewport" content = "width=device-width, initial-scale=1">
    <title>lelugom's blog</title>
    <link rel="shortcut icon" href="https://images.unsplash.com/photo-1473970367503-7d7f8d1bf998?ixlib=rb-0.3.5&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=200&fit=max&s=80e38058ebf664487e8f1d436580abf6">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <style type="text/css">
      body {
        background-image: url("https://images.unsplash.com/photo-1435777940218-be0b632d06db?ixlib=rb-0.3.5&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=1080&amp;fit=max&amp;s=18cb0153c5365100ee6b46d1180c5f1d");
        background-repeat: repeat;
        background-size: cover;
        font-family: "Comic Sans MS", cursive, sans-serif;
        text-align: justify;
      }
      h2 {
        text-align: center !important;
      }
      .post {
        background-color: white;
        margin-bottom: 10px;
        border-radius: 5px;
      }
      .index {
        background-color: white;
        margin-bottom: 10px;
        border-radius: 3px;
        padding: 10px;
        overflow-y: auto;
        /*height: 500px;*/
      }
      #mainPane {
        margin-top: 60px;
      }
      .hidden {
        visibility: hidden;
      }
      .twitter-follow-button {
          margin: 10px 10px 0 10px;
      }
    </style>
  </head>
  <body>
    <!-- Navigation bar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#index-collapse" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="">Blog</a>
        </div>
        <div class="collapse navbar-collapse" id="index-collapse">
          <ul class="nav navbar-nav">
            <li><a id="homeBttn" href="index.html">Home</a></li>
          </ul>
          <div class="nav navbar-nav navbar-right">
            <a class="twitter-follow-button" href="https://twitter.com/lelugom" data-size="large" data-show-count="false">Follow @lelugom</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main panel -->
    <div class="container" id="mainPane"></div>

    <!-- Posts -->
    <div class = "hidden">
      <div class="post" id="20161107">
        <h2>Access Twitter REST API from Perl</h2>
        <p>&nbsp;</p>
        <p class="intro">Twitter provides services to access information from the site through REST APIs. The HTTP process makes GET and POST requests in order to read or write data, and the Twitter endpoint sends responses to those requests using the JSON format. All requests should use Oauth authentication in order to identify particular users and applications accessing Twitter services.</p>

        <p>This script will show you how to use the user authentication model to access the Twitter API, which is based on the open protocol Oauth 1.0. First, go to <a href="https://apps.twitter.com/">apps.twitter.com</a> and login with your username and password. Then, click on the <var>Create New App</var> button. Name your app appropriately and fill in the requested data. Access your newly created application and click on the <var>Keys and Access Tokens</var> tab. You will need four keys from this tab

          <ul>
            <li>Consumer Key (API Key)</li>
            <li>Consumer Secret (API Secret)</li>
            <li>Access Token</li>
            <li>Access Token Secret</li>
          </ul>
        </p>

        <p>Make sure you don't share neither your <var>Consumer Secret</var> nor your <var>Access Token Secret</var> with anyone. You can download the script from <a href="https://github.com/lelugom/scripts/blob/master/perl_oauth_twitter.pl">perl_oauth.pl <span class="glyphicon glyphicon-download-alt"></span></a> and modify the keys accordingly. Let's import the modules for the script and define constants with the four keys from the <a href="https://apps.twitter.com/">apps.twitter.com</a> page. Include the base url to access the REST API as well</p>

          <pre>
  #!/usr/bin/perl
  use strict;
  use warnings;
  use URI::Escape;
  use JSON::PP;
  use Digest::MD5 qw(md5_hex);
  use Digest::SHA qw(hmac_sha1_base64);
  use Time::HiRes qw(time);

  use constant {
    CONSUMER_KEY => "Consumer key",
    SECRET_KEY   => "Consumer secret",
    OAUTH_TOKEN  => "Access token",
    SECRET_TOKEN => "Access token secret",
    TWITTER_API  => "https://api.twitter.com/1.1/statuses/",
  };
          </pre>

        <p>Declare a function with three parameters. A string for the type of request, a string for the url to be accessed and a hash for the parameters of the HTTP request. Declare local variables including a hash with OAuth parameters. The function <code>md5_hex</code> will be used for computing a unique random value for each request. This value will be stored in the variable <code>oauth_nonce</code>, its parameters are a random number concatenated to the result of the function <code>time</code> from Time::HiRes module. The HTTP data hash will be merged with the OAuth parameters for the subsequent computations</p>
        <pre>
  sub twitterOauth {
    my ($req, $url, %getData) = @_;
    my $secret_token = SECRET_TOKEN;
    my $secret_key = SECRET_KEY;
    my ($oauth_signature, $base_signature, $signing_key, $authorization, $response,
      $parameter) =  ('', '', '', '', '', '');
    my %oauth_parameters = (
      "oauth_consumer_key"     => CONSUMER_KEY,
      "oauth_nonce"            => md5_hex(int time() . int rand(~0)),
      "oauth_signature_method" => "HMAC-SHA1",
      "oauth_timestamp"        => int time(),
      "oauth_token"            => OAUTH_TOKEN,
      "oauth_version"          => "1.0",
      );

    $url = TWITTER_API . $url;
    %oauth_parameters = (%oauth_parameters, %getData);
        </pre>

        <p>The signature method <var>HMAC-SHA1</var> will be used for computing the Oauth signature, this method is provided by the function <code>hmac_sha1_base64</code> in the module Digest::SHA. First, create a string separated by &amp; characters containing all the data in the Oauth parameters hash, using the <code>key=value</code> format. Parameter keys should be sorted in alphabetical order. Then, create the base signature string by concatenating the HTTP method in uppercase with the percent encoded URL and the percent encoded string for oauth parameters, joining the strings with the &amp; character.</p>
        
        <p> Create the signing key by concatenating the <var>Consumer Secret</var> with the <var>Access token secret</var>, joining the strings with the &amp; character. Remember to percent encode each string before concatenation. Now, compute the oauth signature with the base signature and the signing key. It's important to know that CPAN digest modules don't pad the computed base64 signature by convention. Therefore, manually pad the computed signature with the code from the <a href="http://search.cpan.org/~mshelor/Digest-SHA-5.96/lib/Digest/SHA.pm#PADDING_OF_BASE64_DIGESTS">CPAN documentation</a> to avoid authentication errors when accessing the API</p>
        <pre>
    foreach $parameter (sort keys %oauth_parameters){
      $base_signature .= "$parameter=$oauth_parameters{$parameter}&"
    }
    chop($base_signature); #remove trailing & character

    $base_signature = uc($req) . '&' . uri_escape($url) . '&' . uri_escape($base_signature);
    $signing_key = uri_escape($secret_key) . '&' . uri_escape($secret_token);
    $oauth_signature = hmac_sha1_base64($base_signature, $signing_key);
    # Pad base64 output, CPAN Digest modules don't pad by convention
    while (length($oauth_signature) % 4) {
      $oauth_signature .= '=';
    }
        </pre>
        <p>Now we are ready to build the authorization string for the HTTP request. Use the <code>key=value</code> format and remember to percent encode each value. </p>
        <pre>
    $authorization = 'OAuth oauth_consumer_key="' . uri_escape($oauth_parameters{"oauth_consumer_key"}) .
      '", oauth_nonce="' . uri_escape($oauth_parameters{"oauth_nonce"}) .
      '", oauth_signature="' . uri_escape($oauth_signature) .
      '", oauth_signature_method="' . uri_escape($oauth_parameters{"oauth_signature_method"}) .
      '", oauth_timestamp="' . uri_escape($oauth_parameters{"oauth_timestamp"}) .
      '", oauth_token="' . uri_escape($oauth_parameters{"oauth_token"}) .
      '", oauth_version="' . uri_escape($oauth_parameters{"oauth_version"}) . '"';
        </pre>
        <p>Let's use curl to access the Twitter API, using the --header option to pass the authorization string. Then, return the JSON formatted string received from API server.</p>
        <pre>
    $parameter = join('&', map{"$_=$getData{$_}"} keys %getData);
    $parameter = "--" . lc($req) . " \'$url\' --data \'$parameter\' --header \'Authorization: $authorization\'";
    $response = curl($parameter);

    return $response;
  }

  sub curl {
    my ($curl_args) = @_;
    my $response;

    # System call for curl
    $curl_args = 'curl -k --silent -A "' .
      'Mozilla/5.0 (Windows NT x.y; Win64; x64; rv:10.0) Gecko/20100101 Firefox/10.0" ' .
      "$curl_args 2>&1";
    $response = qx{$curl_args};
    die "Unable to download webpage $curl_args " if ( $? == -1 );

    return $response;
  }
        </pre>
        <p> As an example, here is the code to download the last 12 tweets from the <a href="https://twitter.com/twitterdev">@twitterdev</a> account and print the JSON formatted string in the standard output. The <a href="https://dev.twitter.com/rest/reference/get/statuses/user_timeline"> GET statuses/user_timeline </a> HTTP request will be send. Remember to use JSON::PP module to decode the returned string for you particular needs.
        </p>
        <pre>
  print twitterOauth("GET", "user_timeline.json", (screen_name => "twitterdev", count => 12)); </pre>
      </div>

      <div class="post" id="20161205">
        <h2>Convert HP LJ1000 into a network printer with OpenWrt</h2>
        <p>&nbsp;</p>
        <p class="intro">The HP LaserJet 1000 is a black and white printer which comes with a USB cable to connect directly to a port in your computer. Nevertheless, if you have a router with OpenWrt installed and a spare USB port on it, you can connect your USB printer to the router and share it in your Local Area Network to allow access from any Windows or Linux computer.</p>

        <p>To make this happen, you need both a firmware file for the printer and a printer server. The drivers for the printer send the firmware file every time the printer powers on, so the router should do the same. To get the printer firmware file, we will use <a href="http://foo2zjs.rkkda.com/">foo2zjs</a>, an open source printer driver which supports HP LJ1000 printer. So, let's download the driver and unpack it </p>

        <pre>
  $ wget -O foo2zjs.tar.gz http://foo2zjs.rkkda.com/foo2zjs.tar.gz
  $ tar zxf foo2zjs.tar.gz
  $ cd foo2zjs</pre>

        <p>Compile and install it </p>
        <pre>
  $ make
  $ ./getweb 1000
  $ sudo make install</pre>

        <p>Now, under the foo2zjs folder. you will find the file <var>sihp1000.dl</var>, which is the firmware file that should be sent to the printer every time it powers on. Store this file in your router file system under the folder <code>/etc/config</code> to preserve it whenever you update the router with the <code>sysupgrade</code> command. We will use the <a href="http://man.cx/p910nd">p910nd</a> printer server, a small non-spooling printer daemon intended for disk-less linux hosts, which copies any data received on the port it is listening on to the corresponding printer port. Let's install the printer server and the USB printing module <code>kmod-usb-printer</code></p>
        <pre>
  $ opkg update
  $ opkg install kmod-usb-printer p910nd</pre>

        <p>Modify firewall configuration on <code>/etc/config/firewall</code> to accept packets on on TCP port 9100</p>
        <pre>
  # Allow attached network printer hplj1000
  config 'rule'
      option 'src' 'lan'
      option 'proto' 'tcp'
      option 'dest_port' '9100'
      option 'target' 'ACCEPT'</pre>

        <p>Check the file <code>/etc/config/p910nd</code> has the following information, assuming your router IP is <var>192.168.1.1</var></p>
        <pre>
  config p910nd
    	option device        /dev/usb/lp0
    	option port          0
    	option bidirectional 1
    	option enabled       1
    	option bind          192.168.1.1</pre>

        <p>We need a script to send the firmware file to the printer any time it powers on. So, let's create the script <code>/etc/hotplug.d/usb/hplj1000</code>. Remember that we store the firmware file <var>sihp1000.dl</var> under the folder <code>/etc/config</code> </p>
        <pre>
  #!/bin/sh

  FIRMWARE="/etc/config/sihp1000.dl"

  if [ "$PRODUCT" = "3f0/517/120" ]
  then
          if [ "$ACTION" = "add" -a "$DEVTYPE" = "usb_interface" ]
          then
                  logger "Sending firmware to HP LJ1000 printer..."
                  cat $FIRMWARE > /dev/usb/lp0
                  logger "done."
          fi
  fi</pre>

        <p>Start and enable the printer daemon</p>
        <pre>
  /etc/init.d/p910nd start
  /etc/init.d/p910nd enable</pre>

        <p>At this point, the printer daemon is up and running. The next step is to install the printer on the computer. Depending on the OS on your computer, follow the instructions <a href="https://wiki.openwrt.org/doc/howto/p910nd.server#configuration_part_2_the_clients">here</a>, and use your router IP address and the port <var>9100</var>.</p>

        <p>Finally, if you need to spool jobs, there is an easy workaround. After installing the network printer on your computer, go to <a href="https://www.google.com/cloudprint">Google cloud print</a> and add the printer using the <var>Add a Classic Printer</var> option. Then, share this printer to the users you need. This way, any person with the shared printer can send print jobs, and they will be sent to the printer whenever chrome runs on your computer. Remember to synchronize chrome to your Google account for the spooling to work.</p>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script type="text/javascript">
      // Load twitter JS to avoid script tags in the HTML elements
      window.twttr = (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0],
          t = window.twttr || {};
        if (d.getElementById(id)) return t;
        js = d.createElement(s);
        js.id = id;
        js.src = "https://platform.twitter.com/widgets.js";
        fjs.parentNode.insertBefore(js, fjs);

        t._e = [];
        t.ready = function(f) {
          t._e.push(f);
        };
        return t;
      }(document, "script", "twitter-wjs"));

      // Fix some document elements
      var gridClass = "col-xs-12 col-md-offset-2 col-md-8";
      $(".post").addClass(gridClass);
      $(".post").each(function() {
        $(this).find('a').each(function(){
          $(this).attr("target", "_blank");
        });
      });

      // Create posts index in main panel
      var index = document.createElement('div');
      $(index).addClass(gridClass + ' index');
      $(".post").each(function() {
        // Assemble entry
        var entry, entryTitle, entryIntro;

        entry = document.createElement('a');
        $(entry).attr('href', '#');
        $(entry).addClass("entry list-group-item");
        $(entry).attr('id', 'entry_' + $(this).attr('id'));

        entryTitle = document.createElement('h4');
        $(entryTitle).addClass('list-group-item-heading');
        $(entryTitle).html($(this).children('h2')[0].innerHTML);

        entryIntro = document.createElement('p');
        $(entryIntro).addClass('list-group-item-text');
        $(entryIntro).html('<br/>' + $(this).children('.intro')[0].innerHTML +
          '<br/><br/><small>Read more ...</small>');

        $(entry).append(entryTitle);
        $(entry).append(entryIntro);
        $(index).append(entry);
      });
      $("#mainPane").append(index);

      // Events
      // click function does not work cause elements were created after
      // loading DOM. So, use on function
      $(document).on("click", ".entry", function(event){
        event.preventDefault();
        loadPost(this);
      });

      // Add selected post to main Pane
      function loadPost(entry){
        var index = $(entry).attr('id').match(/\d+/g)[0];
        $("#mainPane").empty();
        $("#mainPane").append($('#' + index).clone());
      }
    </script>
  </body>
</html>
